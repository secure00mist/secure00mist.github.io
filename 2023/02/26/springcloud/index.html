



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="java" />


<link rel="canonical" href="http://example.com/2023/02/26/springcloud/">



  <title>springcloud学习笔记 |
securemist =  = fsadfa</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">springcloud学习笔记
  </h1>

          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">securemist</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclx6phq6j20zk0m8e36.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicm07ih54j20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeu1usa7j20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicliierfjj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipet4bz0yj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipey0a334j20zk0m8qpt.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="page wrap">
    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/26/springcloud/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/header.jpg">
    <meta itemprop="name" content="securemist222">
    <meta itemprop="description" content="fsadfa, fasf">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h2 id="系统架构的演变"><a href="#系统架构的演变" class="headerlink" title="系统架构的演变"></a>系统架构的演变</h2><p>单机架构</p>
<img data-src="E:\Notes\picture\image-20230224184231504.png" alt="image-20230224184231504" style="zoom: 50%;" />

<p>动静分离架构 :  静态缓存 + 文件存储</p>
<ul>
<li>java程序等为动态资源</li>
<li>图片等为静态资源</li>
</ul>
<img data-src="E:\Notes\picture\image-20230224184141174.png" alt="image-20230224184141174" style="zoom: 50%;" />

<p>分布式架构 :  业务拆分 + 负载均衡</p>
<img data-src="E:\Notes\picture\image-20230224184604273.png" alt="image-20230224184604273" style="zoom: 50%;" />

<p>微服务架构 :  SpringCloud</p>
<h2 id="微服务-amp-SpringCloud"><a href="#微服务-amp-SpringCloud" class="headerlink" title="微服务&amp;SpringCloud"></a>微服务&amp;SpringCloud</h2><p>微服务是系统架构上的一种设计风格，它的主旨==是将一个原本独立的系统拆分成多个小型服务==，这些小型服务都在各自独立的进程中运行，服务之间通过基于 HTTP 的 RESTfulAPI 进行通信协作。</p>
<p>==被拆分成的每一个小型服务都围绕着系统中的某一项或一些耦合度较高的业务功能进行构建==， 并且每个服务都维护着自身的数据存储、 业务开发、自动化测试案例以及独立部署机制。 由于有轻量级的通信协作基础， 所以这些微服务可以使用不同的语言来编写。</p>
<h3 id="SpringCloud说明"><a href="#SpringCloud说明" class="headerlink" title="SpringCloud说明"></a>SpringCloud说明</h3><p>SpringCloud  :  一套标准化的微服务解决方案   <span class="exturl" data-url="aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLWNsb3Vk">Spring Cloud</span></p>
<ul>
<li>Spring Cloud 是 Spring 社区为微服务架构提供的一个 “全家桶” 套餐。套餐中各个组件之间的配合， 可以减少在组件的选型和整合上花费的精力，可以快速构建起基础的微服务架构系统，是微服务架构的最佳落地方案</li>
<li>Spirng Cloud 天然支持 Spring Boot(有版本对应要求)，使用门槛较低</li>
</ul>
<p>SpringCoud解决问题  </p>
<ul>
<li>解决与分布式系统相关的复杂性 – 网络问题，延迟开销，带宽问题，安全问题</li>
<li>处理服务发现的能力 – 服务发现允许集群中的进程和服务找到彼此并进行通信</li>
<li>解决冗余问题 – 冗余问题经常发生在分布式系统中</li>
<li>解决负载平衡 – 改进跨多个计算资源（例如计算机集群，网络链接，中央处理单元）的工作负载分布</li>
</ul>
<h3 id="SpringCloud核心组件"><a href="#SpringCloud核心组件" class="headerlink" title="SpringCloud核心组件"></a>SpringCloud核心组件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">	head(Spring Cloud 核心组件)</span><br><span class="line">	head --&gt; id1(Sleuth 分布式服务器跟踪组件)</span><br><span class="line">	head --&gt; id2(Bus 消息总线组件)</span><br><span class="line">	head --&gt; id3(Config 分布式配置中心组件)</span><br><span class="line">	head --&gt; alibaba(SpringCloud Alibaba)</span><br><span class="line">    head --&gt; NetFlix(SpringCloud Netflix)</span><br><span class="line">    </span><br><span class="line">    d1(消息驱动组件 stream) --&gt; head</span><br><span class="line">    d2(声明式服务器调用组件 Open Feign) --&gt; head</span><br><span class="line">    d3(AIP 网关 gateway)--&gt; head</span><br></pre></td></tr></table></figure>





<h3 id="SpringCloud分布式示意图"><a href="#SpringCloud分布式示意图" class="headerlink" title="SpringCloud分布式示意图"></a>SpringCloud分布式示意图</h3><img data-src="E:\Notes\picture\image-20230224191012095.png" alt="image-20230224191012095" style="zoom:67%;" />

<h3 id="SpringCloud组件选型"><a href="#SpringCloud组件选型" class="headerlink" title="SpringCloud组件选型"></a>SpringCloud组件选型</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">	head(SpringCloud组件选型)</span><br><span class="line">	</span><br><span class="line">	head --&gt; a(服务注册中心)</span><br><span class="line">		 a --- a1(!!Rrueka) --- a2(Nacos) --- a3(Zookeeper) --- a4(Consul)</span><br><span class="line">    head --&gt; b(服务器负载均衡)</span><br><span class="line">    	b --- b1(Ribbon) --- b2(LoadBalancer)</span><br><span class="line">    head --&gt; c(服务器熔断降级)</span><br><span class="line">    	c --- c1(!!Hystrix) --- c2(Sentinel)</span><br><span class="line">    head --&gt; d(服务调用)</span><br><span class="line">    	d --- d1(!!Feign) --- d2(Open Feign)</span><br><span class="line">    head --&gt; e(服务网关)</span><br><span class="line">    	e --- e1(!!Zuul) --- e2(GateWay)</span><br><span class="line">    head --&gt; f(服务配置)</span><br><span class="line">		f --- f1(!!Config) --- f2(Nacos)</span><br><span class="line">	head --&gt; g(服务总线)</span><br><span class="line">		g --- g1(!!Bus) --- g2(Nacos)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li><p>Spring Cloud Alibaba 组件为主</p>
</li>
<li><p>Spring Cloud 为辅， 比如(SpringCloud- Ribbon∶ 负载均衡、SpringCloud-OpenFeign∶ 调</p>
<p>用远程服务、 SpringCloud-Gateway∶ API 网关、SpringCloud-Sleuth∶ 调用链监控 等) 还</p>
<p>是非常不错的</p>
</li>
</ul>
<h2 id="cloud项目构建"><a href="#cloud项目构建" class="headerlink" title="cloud项目构建"></a>cloud项目构建</h2><h3 id="dependencyManagement说明"><a href="#dependencyManagement说明" class="headerlink" title="dependencyManagement说明"></a>dependencyManagement说明</h3><p>1、Maven 使用 <code>dependencyManagement</code> 元素来提供了一种管理依赖版本号 的 方 式 。 通 常 在 项 目 packaging 为 POM, 中 使 用<code>dependencvManadement</code> 元素。<br>2、使用 pom.xml 中的 <code>dependencyManagement</code> 元素能让所有在子项目中引用一个依赖, Maven 会沿着父子层次向上走，直到找到一个拥有<code>dependencyManagement</code> 元 素 的 项 目 ， 然 后 它 就 会 使 用 这 个<code>dependencyManagement</code> 元素中指定的版本号。<br>3、好处∶如果有多个子项目都引用同一样依赖，则可以避免在每个使用的子项目里都声明一个版本号，当升级或切换到另一个版本时，只需要在顶层父容器里更新，而不需要分别在子项目的修改;另外如果某个子项目需要另外的一个版<br>本，只需要声明 version 就可。<br>4、==dependencyManagement 里只是声明依赖，并不实现引入==，因此子项目需要显示的声明需要用的依赖。<br>5、如果不在子项目中声明依赖，是不会从父项目中继承下来的; 只有在子项目中写了该依赖项，并且没有指定具体版本，才会从父项目中继承该项，并且version 和 scope 都读取自父 pom</p>
<p>6、如果子项目中指定了版本号，那么会使用子项目中指定的 jar 版本</p>
<p>scope作用范围</p>
<table>
<thead>
<tr>
<th><code>scope</code></th>
<th>主代码</th>
<th>测试代码</th>
<th>打包</th>
<th>范例</th>
</tr>
</thead>
<tbody><tr>
<td><code>compile(默认)</code></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td><code>log4j</code></td>
</tr>
<tr>
<td><code>test</code></td>
<td></td>
<td>Y</td>
<td></td>
<td><code>junit</code></td>
</tr>
<tr>
<td><code>provider</code></td>
<td>Y</td>
<td>Y</td>
<td></td>
<td><code>servlet-spi</code></td>
</tr>
<tr>
<td><code>runtime</code></td>
<td></td>
<td></td>
<td>Y</td>
<td><code>jdbc</code></td>
</tr>
</tbody></table>
<p><code>&lt;optional&gt;true&lt;/optional&gt;</code> :  防止将该依赖传递到其他模块中</p>
<p>比如 A 模块依赖了本项目, 那么本项目不会把 lombok 传递给 B</p>
<h3 id="注入ResTemplate"><a href="#注入ResTemplate" class="headerlink" title="注入ResTemplate"></a>注入ResTemplate</h3><p><code>https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframe work/web/client/RestTemplate.html</code></p>
<p>RestTemplate 是 Spring 提供的用于访问，Rest 服务的模板类,提供了多种便捷==访问远程 Http 服务==的方法</p>
<p>通过 RestTemplate, 我们可以发出 http 请求(支持Restful 风格), 去调用 Controller 提供的 API 接口, 就像我们使用浏览器发出 http 请求,调用该 API 接口一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/consumer/add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Member&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> Member member)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.postForObject(MEMBER_SERVICE_NACOS_PROVIDER_URL + <span class="string">&quot;/member/add&quot;</span>, member, Result.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开启-Run-DashBoard"><a href="#开启-Run-DashBoard" class="headerlink" title="开启 Run DashBoard"></a>开启 Run DashBoard</h3><p>当 springcloud 的服务有多个时，管理多个服务的启动使用 run 会不好管理，这样我们就可以使用 RunDashboard</p>
<p><code>/.idea/workspace.xml</code> 文件在其中添加下面的代码即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;RunDashboard&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;configurationTypes&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;SpringBootApplicationConfigurationType&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;ruleStates&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RuleState</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ConfigurationTypeDashboardGroupingRule&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">RuleState</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RuleState</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;StatusDashboardGroupingRule&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">RuleState</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka "></a>Eureka </h2><h3 id="Eureka项目架构分析"><a href="#Eureka项目架构分析" class="headerlink" title="Eureka项目架构分析"></a>Eureka项目架构分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph BT</span><br><span class="line">    A(调用会员中心-服务消费方\n consumer)</span><br><span class="line">    B(会员中心-提供服务\n provider ...)</span><br><span class="line">    C(Eureka Server ...)</span><br><span class="line">        A --&gt;| 发现服务/得到注册服务| C</span><br><span class="line"></span><br><span class="line">        B --&gt; |注册服务| C</span><br><span class="line">        A--&gt; |远程调用| B</span><br></pre></td></tr></table></figure>



<p>Eureka Server 提供注册服务, 各个微服务节点通过配置启动后，会在 Eureka Server 中进行注册，这样 EurekaServer 中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观看到。</p>
<p>心跳连接机制 : </p>
<p>EurekaClient 通过注册中心进行访问, 是一个 Java 客户端，用于简化 Eureka Server 的交互，客户端同时也具备一个内置的、使用轮询(round-robin) 负载算法的负载均衡器。在应用启动后，将会向 Eureka Server 发送心跳(默认周期为 30 秒)。如果 Eureka Server 在多个心跳周期内没有接收到某个节点的心跳，EurekaServer 将会从服务注册表中把这个服务节点移除(默认 90 秒)</p>
<p>服务治理 : </p>
<ul>
<li><p>服务治理实现服务调用、负载均衡、容错等，实现服务发现与注册</p>
</li>
<li><p>在传统的 rpc 远程调用框架中，管理每个服务与服务之间依赖关系比较复杂，管理困难，所以需要治理服务之间依赖关系</p>
</li>
</ul>
<p>系统中的其他微服务，使用 Eureka的客户端连接到 Eureka Server并维持心跳连接，==通过 Eureka Server 来监控系统中各个微服务是否正常运行==。</p>
<p>服务注册 :  将服务信息注册到Server注册中心</p>
<ul>
<li>在服务注册与发现中，有一个注册中心。==当服务器启动的时候，会把当前自己服务器的信息== 比如 服务地址通讯地址等==以别名方式注册到注册中心上==</li>
</ul>
<p>服务发现 :  从注册中心获取注册服务</p>
<ul>
<li>服务消费者或者服务提供者，以服务别名的方式去注册中心上获取到实际的服务提供者通讯地址，然后通过RPC调用服务</li>
</ul>
<h3 id="项目构建"><a href="#项目构建" class="headerlink" title="项目构建"></a>项目构建</h3><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>Eureka配置信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端的实例名字</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#不向注册中心注册自己</span></span><br><span class="line">    <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#设置与 eureka server 交互的模块,查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>



<p>将服务注册到Eureka的配置信息，配置在微服务模块</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#将自己注册到 EurekaServer</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span> </span><br><span class="line">    <span class="comment">#是否从从 EurekaServer 抓取注册信息，默认为 true, 单节点无所谓，</span></span><br><span class="line">    <span class="comment">#集群必须设置为 true 才能配合 ribbon 使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span> </span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#表示将自己注册到哪个 eurekaServer</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:9001/eureka</span></span><br></pre></td></tr></table></figure>



<p>Eureka启动类增加注解 <code>@EnableEurekaServer</code></p>
<p>微服务模块启动类增加注解 : <code>@EnableEurekaClient</code></p>
<h3 id="维护机制"><a href="#维护机制" class="headerlink" title="维护机制 :"></a>维护机制 :</h3><img data-src="E:\Notes\picture\image-20230225102729147.png" alt="image-20230225102729147" style="zoom: 50%;" />

<p>consumer:</p>
<ul>
<li>服务消费者需要调用接口时，使用服务别名去注册中心，获取实际的RPC的远程调用地址</li>
<li>消费者得到调用地址，底层使用HttpClient技术实现</li>
<li>消费者获取到的调用地址，会缓存到JVM内存中</li>
<li>默认每隔30s去更新一次服务调用地址</li>
</ul>
<p>privoder : </p>
<ul>
<li>启动Eureka Server</li>
<li>启动服务提供者</li>
<li>把自己的信息注册到Server</li>
<li>通过心跳机制维护状态</li>
</ul>
<p>Eureka Server :</p>
<ul>
<li>服务注册 : 将服务信息注册到Server</li>
<li>服务发现 : 从注册中心获取到注册服务</li>
<li>服务信息 : Key : 服务名 —–  Value : 调用</li>
</ul>
<h3 id="Eureka自我保护模式"><a href="#Eureka自我保护模式" class="headerlink" title="Eureka自我保护模式"></a>Eureka自我保护模式</h3><p>在默认情况下， Eureka 启动了自我保护模式</p>
<p>自我保证机制/模式说明:</p>
<ul>
<li><p>默认情况下EurekaClient定时向EurekaServer端发送心跳包，如果Eureka在server端在一定时间内（默认90秒）没有收到EurekaClient发送心跳包，便会直接从服务注册列表中剔除该服务</p>
</li>
<li><p>如果Eureka 开启了自我保护模式/机制, 那么在短时间（90秒中）内丢失了大量的服务实例心跳，==这时候EurekaServer会开启自我保护机制，不会剔除该服务==（该现象可能出现在如果网络不通或者阻塞) 因为客户端还能正常发送心跳，只是网络延迟问题，而保护机制是为了解决此问题而产生的</p>
</li>
</ul>
<p>自我保护是 属于 CAP 里面的 AP 分支， 保证高可用和分区容错性</p>
<p>自我保护模式是—种应对网络异常的安全保护措施。它的架构哲学是==宁可同时保留所有微服务==（健康的微服务和不健康的微服务都会保留）==也不盲目注销任何健康的微服务==。<code>https://blog.csdn.net/wangliangluang/article/details/120626014</code></p>
<p>自我保护配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"> <span class="attr">server:</span></span><br><span class="line">   <span class="comment">#禁用自我保护模式</span></span><br><span class="line">   <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">   <span class="comment">#超时时间2s</span></span><br><span class="line">   <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"> <span class="attr">instance:</span></span><br><span class="line">   <span class="comment">#客户端向服务端发送心跳的实践间隔 s</span></span><br><span class="line">   <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">   <span class="comment">#服务端在收到最后一次心跳后等待时间上限</span></span><br><span class="line">   <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>



<h3 id="搭建Eureka集群"><a href="#搭建Eureka集群" class="headerlink" title="搭建Eureka集群"></a>搭建Eureka集群</h3><p>为什么需要搭建集群 : </p>
<ul>
<li>微服务 RPC 远程服务调用最核心的是实现高可用</li>
<li>如果注册中心只有 1 个，它出故障，会导致整个服务环境不可用</li>
<li>解决办法∶搭建 Eureka 注册中心集群，实现负载均衡+故障容错</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph BT</span><br><span class="line">    A(服务消费方\n consumer)</span><br><span class="line">    B(服务提供方\n provider ...)</span><br><span class="line">    C(Eureka Server 1)</span><br><span class="line">    C1(Eureka Server 2 )</span><br><span class="line"></span><br><span class="line">        A -- 发现服务/得到注册服务--&gt; C</span><br><span class="line">	</span><br><span class="line">        B -- 注册服务--&gt; C</span><br><span class="line">        A--  远程调用----&gt;  B</span><br><span class="line">        </span><br><span class="line">        C &lt;--互相调用--&gt; C1</span><br><span class="line">   </span><br><span class="line">       </span><br><span class="line">        </span><br></pre></td></tr></table></figure>



<img data-src="E:\Notes\picture\image-20230225112259437.png" alt="image-20230225112259437" style="zoom: 50%;" />



<h3 id="DiscoverClient"><a href="#DiscoverClient" class="headerlink" title="DiscoverClient"></a>DiscoverClient</h3><p>获取Eureka Server服务注册信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">discovery</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;服务名=&#123;&#125;&quot;</span>, service);</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(service);</span><br><span class="line">        <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;id=&#123;&#125;,host=&#123;&#125;,port=&#123;&#125;,uri=&#123;&#125;&quot;</span>, instance.getServiceId(),</span><br><span class="line">                    instance.getHost(), instance.getPort(), instance.getUri());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动类增加注解<code>@EnableDiscoveryClient</code></p>
<h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><blockquote>
<p>Ribbon: 负载均衡+RestTemplate 调用</p>
</blockquote>
<p><code>https://github.com/Netflix/ribbon</code></p>
<h3 id="Load-Balance分类"><a href="#Load-Balance分类" class="headerlink" title="Load Balance分类"></a>Load Balance分类</h3><p>集中式 LB</p>
<ul>
<li><p>即在服务的消费方和提供方之间使用独立的LB设施即在服务的消费方和提供方之间使用独立的LB设施,由该设施负责把访问请求通过某种策略转发至服务的提供方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">	A[消费方]</span><br><span class="line">	B-1[提供方1]</span><br><span class="line">	B-2[提供方2]	</span><br><span class="line">	B-3[提供方3]</span><br><span class="line">	LB(负载均衡)</span><br><span class="line">	</span><br><span class="line">	A --&gt; LB</span><br><span class="line">		LB --&gt; B-1</span><br><span class="line">		LB --&gt; B-2</span><br><span class="line">		LB --&gt; B-3</span><br></pre></td></tr></table></figure></li>
</ul>
<p>进程内 LB</p>
<ul>
<li><p>将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些服务地址可用，然后再从这些地址中选择出一个合适的服务地址</p>
</li>
<li><p>Ribbon就属于进程内LB，它只是一个类库，==集成于消费方进程==，消费方通过它来获取到服务提供方的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">	A[消费方]</span><br><span class="line">	B-1[提供方1]</span><br><span class="line">	B-2[提供方2]	</span><br><span class="line">	B-3[提供方3]</span><br><span class="line">	LB(注册中心)</span><br><span class="line">	</span><br><span class="line">	cache --负载均衡请求----&gt; B-1</span><br><span class="line">	cache --负载均衡请求----&gt; B-2</span><br><span class="line">	cache --负载均衡请求----&gt; B-3</span><br><span class="line"></span><br><span class="line">	cache -- 注册--&gt; LB</span><br><span class="line">	LB -- 查询可用服务列表--&gt; cache</span><br><span class="line">    B-1 --注册----&gt; LB</span><br><span class="line">	B-2 --注册----&gt;  LB</span><br><span class="line">	B-3 --注册----&gt;  LB</span><br><span class="line">	subgraph cache</span><br><span class="line">		A &lt;--服务请求--&gt; 缓存</span><br><span class="line">	end</span><br><span class="line">	</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">C4Context</span><br><span class="line">  title System Context diagram for Internet Banking System</span><br><span class="line">  Enterprise_Boundary(b0, &quot;BankBoundary0&quot;) &#123;</span><br><span class="line">    Person(customerA, &quot;Banking Customer A&quot;, &quot;A customer of the bank, with personal bank accounts.&quot;)</span><br><span class="line">    Person(customerB, &quot;Banking Customer B&quot;)</span><br><span class="line">    Person_Ext(customerC, &quot;Banking Customer C&quot;, &quot;desc&quot;)</span><br><span class="line"></span><br><span class="line">    Person(customerD, &quot;Banking Customer D&quot;, &quot;A customer of the bank, &lt;br/&gt; with personal bank accounts.&quot;)</span><br><span class="line"></span><br><span class="line">    System(SystemAA, &quot;Internet Banking System&quot;, &quot;Allows customers to view information about their bank accounts, and make payments.&quot;)</span><br><span class="line"></span><br><span class="line">    Enterprise_Boundary(b1, &quot;BankBoundary&quot;) &#123;</span><br><span class="line"></span><br><span class="line">      SystemDb_Ext(SystemE, &quot;Mainframe Banking System&quot;, &quot;Stores all of the core banking information about customers, accounts, transactions, etc.&quot;)</span><br><span class="line"></span><br><span class="line">      System_Boundary(b2, &quot;BankBoundary2&quot;) &#123;</span><br><span class="line">        System(SystemA, &quot;Banking System A&quot;)</span><br><span class="line">        System(SystemB, &quot;Banking System B&quot;, &quot;A system of the bank, with personal bank accounts. next line.&quot;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      System_Ext(SystemC, &quot;E-mail system&quot;, &quot;The internal Microsoft Exchange e-mail system.&quot;)</span><br><span class="line">      SystemDb(SystemD, &quot;Banking System D Database&quot;, &quot;A system of the bank, with personal bank accounts.&quot;)</span><br><span class="line"></span><br><span class="line">      Boundary(b3, &quot;BankBoundary3&quot;, &quot;boundary&quot;) &#123;</span><br><span class="line">        SystemQueue(SystemF, &quot;Banking System F Queue&quot;, &quot;A system of the bank.&quot;)</span><br><span class="line">        SystemQueue_Ext(SystemG, &quot;Banking System G Queue&quot;, &quot;A system of the bank, with personal bank accounts.&quot;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BiRel(customerA, SystemAA, &quot;Uses&quot;)</span><br><span class="line">  BiRel(SystemAA, SystemE, &quot;Uses&quot;)</span><br><span class="line">  Rel(SystemAA, SystemC, &quot;Sends e-mails&quot;, &quot;SMTP&quot;)</span><br><span class="line">  Rel(SystemC, customerA, &quot;Sends e-mails to&quot;)</span><br><span class="line"></span><br><span class="line">  UpdateElementStyle(customerA, $fontColor=&quot;red&quot;, $bgColor=&quot;grey&quot;, $borderColor=&quot;red&quot;)</span><br><span class="line">  UpdateRelStyle(customerA, SystemAA, $textColor=&quot;blue&quot;, $lineColor=&quot;blue&quot;, $offsetX=&quot;5&quot;)</span><br><span class="line">  UpdateRelStyle(SystemAA, SystemE, $textColor=&quot;blue&quot;, $lineColor=&quot;blue&quot;, $offsetY=&quot;-10&quot;)</span><br><span class="line">  UpdateRelStyle(SystemAA, SystemC, $textColor=&quot;blue&quot;, $lineColor=&quot;blue&quot;, $offsetY=&quot;-40&quot;, $offsetX=&quot;-50&quot;)</span><br><span class="line">  UpdateRelStyle(SystemC, customerA, $textColor=&quot;red&quot;, $lineColor=&quot;red&quot;, $offsetX=&quot;-50&quot;, $offsetY=&quot;20&quot;)</span><br><span class="line"></span><br><span class="line">  UpdateLayoutConfig($c4ShapeInRow=&quot;3&quot;, $c4BoundaryInRow=&quot;1&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br></pre></td></tr></table></figure>



<h3 id="Ribbon-机制"><a href="#Ribbon-机制" class="headerlink" title="Ribbon 机制"></a>Ribbon 机制</h3><ul>
<li>先选择 EurekaServer，它优先选择在同一个区域内负载较少的 server</li>
<li>再根据用户指定的策略，在从 server 取到的服务注册列表中选择一个地址</li>
<li>Ribbon 提供了多种策略∶ 比如轮询、随机和根据响应时间加权。</li>
</ul>
<h3 id="Ribbon负载均衡算法"><a href="#Ribbon负载均衡算法" class="headerlink" title="Ribbon负载均衡算法"></a>Ribbon负载均衡算法</h3><p>常见负载均衡算法</p>
<p><img data-src="E:\Notes\picture\image-20230225132253975.png" alt="image-20230225132253975"></p>
<p>替换负载均衡算法</p>
<ul>
<li>指定配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">myRibbonRule</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 随机负载均衡算法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在主启动类上使用指定的 Ribbon 负载均衡算法规则(可省略)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RibbonClient(name = &quot;MEMBER_SERVICE_PROVIDER_URL&quot;, configuration = RibbonRule.class)</span></span><br></pre></td></tr></table></figure>



<h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><p><code>https://github.com/spring-cloud/spring-cloud-openfeign</code></p>
<blockquote>
<p>OpenFeign 是个声明式 WebService 客户端，使用 OpenFeign 让编写 Web Service 客户端更简单，可以与 Eureka 和 Ribbon 组合使用以支持负载均衡</p>
</blockquote>
<h3 id="项目构建-1"><a href="#项目构建-1" class="headerlink" title="项目构建"></a>项目构建</h3><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>主启动类增加注解 : <code>@EnableFeignClients</code></p>
<p>service接口 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">com.gong.springcloud.service.MemberFeignService</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// value的值必须为Eureka客户端显示的注册名一致</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;MEMBER-SERVICE-PROVIDER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MemberFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法和注解必须和要调用的接口完全一样   ！！！</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/member/getById/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">getMemberById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h3><p>Feign 提供了日志打印功能，可以通过配置来调整日志级别，从而对 Feign 接口的调用情况进行监控和输出</p>
<p>日志级别</p>
<ul>
<li><code>NONE</code>∶默认的，不显示任何日志</li>
<li><code>BASIC</code>∶仅记录请求方法、URL、响应状态码及执行时间;</li>
<li><code>HEADERS</code>∶除了 BASIC中定义的信息之外，还有请求和响应的头信息; </li>
<li><code>FULL</code>∶除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenFeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.Level <span class="title function_">loggerLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.gong.springcloud.service.MemberFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>常见的日志级别有 5 种，分别是 error、warn、info、debug、trace<br><code>error</code>：错误日志，指比较严重的错误，对正常业务有影响，需要运维配置监控的；<br><code>warn</code>：警告日志，一般的错误，对业务影响不大，但是需要开发关注；<br><code>info</code>：信息日志，记录排查问题的关键信息，如调用时间、出参入参等等；<br><code>debug</code>：用于开发 DEBUG 的，关键逻辑里面的运行时数据；<br><code>trace</code>：最详细的信息，一般这些信息只记录到日志文件中</p>
<h3 id="调用超时"><a href="#调用超时" class="headerlink" title="调用超时"></a>调用超时</h3><p>OpenFeign 默认超时时间 1 秒钟 ，即等待返回结果 1 秒</p>
<p>在某些情况下，一个服务调用时间可能要超过 1 秒，就需要重新设置超时时间</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment">#设置 feign 客户端超时时间（openFeign 默认支持 ribbon)</span></span><br><span class="line">  <span class="comment">#设置超时时间 : 建立连接后从服务器读取到可用资源的时间</span></span><br><span class="line">  <span class="attr">ReadTimeOut:</span> <span class="number">3000</span></span><br><span class="line">  <span class="comment">#建立连接所用的时间，</span></span><br><span class="line">  <span class="attr">ConnectionTimeout:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>





<h2 id="GateWay"><a href="#GateWay" class="headerlink" title="GateWay"></a>GateWay</h2><p>官方文档 : </p>
<p> <code>https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</code></p>
<p>Spring Cloud Gateway 基于 Spring Framework(支持 Spring WebFlux)，Project Reactor 和Spring Boot 进行构建,具有如下特性:</p>
<ul>
<li><p> 动态路由</p>
</li>
<li><p> 可以对路由指定 Predicate(断言)和Filter(过滤器)</p>
</li>
<li><p> 集成Hystrix的断路器功能</p>
</li>
<li><p> 集成 Spring Cloud 服务发现功能</p>
</li>
<li><p> 请求限流功能</p>
</li>
<li><p> 支持路径重写</p>
</li>
</ul>
<h3 id="Gateway网关拓扑图"><a href="#Gateway网关拓扑图" class="headerlink" title="Gateway网关拓扑图"></a>Gateway网关拓扑图</h3><p>简易网关拓扑图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">	DB1[(database)]</span><br><span class="line">	DB2[(database)]</span><br><span class="line">	DB3[(database)]</span><br><span class="line">	</span><br><span class="line">	subgraph 前端</span><br><span class="line">		模块1</span><br><span class="line">		模块2</span><br><span class="line">		模块3</span><br><span class="line">		......</span><br><span class="line">	end</span><br><span class="line">	</span><br><span class="line">	subgraph 网关gateway</span><br><span class="line">		反向代理</span><br><span class="line">		负载均衡</span><br><span class="line">		限流</span><br><span class="line">		熔断</span><br><span class="line">		鉴权</span><br><span class="line">	end</span><br><span class="line">	</span><br><span class="line">	subgraph 集群</span><br><span class="line">		模块2-java后端\nip:xxxxxxx --&gt; DB2</span><br><span class="line">        模块3-java后端\nip:xxxxxxx --&gt; DB3</span><br><span class="line">	end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	前端 --&gt; 网关gateway --&gt; 模块1-java后端\nip:xxxxxxx --&gt; DB1</span><br><span class="line">		    网关gateway --&gt; 集群</span><br></pre></td></tr></table></figure>



<p><img data-src="E:\Notes\picture\88bbf6d38d6eb2ec1aedbddc4bbeccb2.png" alt="img"></p>
<h3 id="Gateway工作机制"><a href="#Gateway工作机制" class="headerlink" title="Gateway工作机制"></a>Gateway工作机制</h3><p>Route(路由)</p>
<ul>
<li>路由是构建网关的基本模块，它由 ID，目标 URI，一系列的断言和过滤器组成，如果断言为 true 则匹配该路由</li>
</ul>
<p>Predicate(断言)</p>
<ul>
<li>对 HTTP 请求中的所有内容（例如请求头或请求参数）进行匹配，如果请求与断言相匹配则进行路由</li>
</ul>
<p>Filter(过滤) :</p>
<ul>
<li>在对 Http 请求断言匹配成功后, 可以通过网关的过滤机制, 对 Http 请求处理</li>
</ul>
<img data-src="E:\Notes\picture\image-20230225160838490.png" alt="image-20230225160838490" style="zoom: 50%;" />



<ol>
<li><p>客户端向 Spring Cloud Gateway 发出请求。然后在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler。</p>
</li>
<li><p>Handler 再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。</p>
</li>
<li><p>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前（”pre(前置处理)”）或之后（”post(后置处理)”）执行业务逻辑。</p>
</li>
<li><p>Filter 在”pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等，</p>
</li>
<li><p>在”post”类型的过滤器中可以做响应内容、响应头的修改，日志的输出，流量监控等有着非常重要的作用。</p>
</li>
</ol>
<p>  总结：路由转发+执行过滤器链</p>
<h3 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h3><p>引入依赖</p>
<p><strong>不能引入 <code>spring-boot-starter-web</code> 和<code>spring-boot-starter-actuator</code> 否则会冲突，因为 gateway 是一个服务网关，不需要 web</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>路由配置</p>
<p>yaml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#配置路由, 可以有多个路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">member_routh01</span></span><br><span class="line">          <span class="comment">#gateway 最终访问的 url = uri+Path 即: http://localhost:10000/memeber/get/</span></span><br><span class="line">          <span class="comment">#匹配后提供服务的路由地址, 也可以是外网 uri,比如 http://www.qq.com 等</span></span><br><span class="line">          <span class="attr">uri:</span></span><br><span class="line">            <span class="string">http://localhost:10000</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言</span></span><br><span class="line">            <span class="comment">#先匹配uri，成功之后匹配路径，如果path匹配成功，最终访问的url就是 uri+Path</span></span><br><span class="line">            <span class="comment">#如果匹配失败，由gateway返回404</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/member/geyById/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">member_routh02</span></span><br><span class="line">          <span class="attr">uri:</span></span><br><span class="line">            <span class="comment">#动态路由</span></span><br><span class="line">            <span class="comment">#lb是负载均衡协议 注册的服务名（小写）</span></span><br><span class="line">            <span class="string">lb://member-service-provider</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/member/add</span></span><br></pre></td></tr></table></figure>



<p><code>@Configuration</code>配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetWayRoutesConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">myRouteLocator3</span><span class="params">(RouteLocatorBuilder locatorBuilder)</span>&#123;</span><br><span class="line">        RouteLocatorBuilder.<span class="type">Builder</span> <span class="variable">routes</span> <span class="operator">=</span> locatorBuilder.routes();</span><br><span class="line">        <span class="keyword">return</span> routes.route(<span class="string">&quot;member_routh3&quot;</span>, r -&gt; r.path(<span class="string">&quot;/member/get/**&quot;</span>).</span><br><span class="line">                uri(<span class="string">&quot;http://localhost:10000&quot;</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h3><p>:star: <code>r -&gt; r.path(&quot;/member/get/**&quot;).</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//Dog dog = hi(&quot;tom&quot;, (String str) -&gt; &#123;</span></span><br><span class="line">        <span class="comment">//    Cat cat = new Cat();</span></span><br><span class="line">        <span class="comment">//    cat.setName(str);</span></span><br><span class="line">        <span class="comment">//    return cat;</span></span><br><span class="line">        <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Dog dog = hi(&quot;tom&quot;,  str -&gt; &#123;</span></span><br><span class="line">        <span class="comment">//    Cat cat = new Cat();</span></span><br><span class="line">        <span class="comment">//    cat.setName(str);</span></span><br><span class="line">        <span class="comment">//    return cat;</span></span><br><span class="line">        <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Dog dog = hi(&quot;tom&quot;,  str -&gt; &#123;</span></span><br><span class="line">        <span class="comment">//    return new Cat(str);</span></span><br><span class="line">        <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> hi(<span class="string">&quot;tom&quot;</span>,  r -&gt; <span class="keyword">new</span> <span class="title class_">Cat</span>(r));</span><br><span class="line">        System.out.println(dog.getName());</span><br><span class="line"></span><br><span class="line">    System.out.println(dog.getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">hi</span><span class="params">(String str, Function&lt;String, Cat&gt; fn)</span>&#123;</span><br><span class="line">    <span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> fn.apply(str);</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">    dog.setName(cat.getName() + <span class="string">&quot;~变成了小狗名&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> dog;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Predicate-断言"><a href="#Predicate-断言" class="headerlink" title="Predicate/断言"></a>Predicate/断言</h3><p><code>https://docs.spring.io/spring-cloud-gateway/docs/3.0.8/reference/html/#gateway-request-predicates-factories</code></p>
<blockquote>
<p>Predicate 就是一组匹配规则，当请求匹配成功，就执行对应的 Route, 匹配失败，放弃处理/转发</p>
</blockquote>
<p>Spring Cloud Gateway包括许多内置的Route Predicate工厂, 所有这些Predicate都与HTTP请求的不同属性匹配, 可以组合使用.</p>
<p>Spring Cloud Gateway 创建 Route 对象时，使用RoutePredicateFactory 创建 Predicate对象，Predicate 对象可以赋值给Route。</p>
<p>所有这些谓词都匹配HTTP请求的不同属性。多种谓词工厂可以组合</p>
<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>自定义Filter</p>
<blockquote>
<p>！！！有问题，全局过滤器失效，不知道哪里出问题了</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomGateWatFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 过滤器业务逻辑</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        MultiValueMap&lt;String, String&gt; params = request.getQueryParams();</span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> params.getFirst(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pwd</span> <span class="operator">=</span> params.getFirst(<span class="string">&quot;pwd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">&quot;root&quot;</span>.equals(user) &amp;&amp; <span class="string">&quot;root&quot;</span>.equals(pwd)))&#123;</span><br><span class="line">            <span class="comment">// 拦截</span></span><br><span class="line">            System.out.println(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//表示该过滤器执行的顺序，数字越小，优先级越高.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Sleuth-Zipkin"><a href="#Sleuth-Zipkin" class="headerlink" title="Sleuth/Zipkin"></a>Sleuth/Zipkin</h2><h3 id="Sleuth与Zipkin的关系"><a href="#Sleuth与Zipkin的关系" class="headerlink" title="Sleuth与Zipkin的关系 :"></a>Sleuth与Zipkin的关系 :</h3><p>在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的的服务节点调用, 来协同产生最后的请求结果，每一个请求都会形成一条复杂的分布式服务调用链路</p>
<p>链路中的任何一环出现高延时或错误都会引起整个请求最后的失败, 因此对整个服务的调用进行链路追踪和分析就非常的重要</p>
<blockquote>
<p>Sleuth 做链路追踪 , Zipkin 做数据搜集/存储/可视化</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">	A(微服务A\nsleuth) </span><br><span class="line">	B(微服务B\nsleuth)</span><br><span class="line">	C(微服务C\nsleuth)</span><br><span class="line">	D(Zipin 收集数据)</span><br><span class="line">subgraph 分布式/微服务架构</span><br><span class="line">	B &lt;--&gt; C</span><br><span class="line">	B &lt;--&gt; A</span><br><span class="line">	</span><br><span class="line">    A --&gt;|send Trace Data| D</span><br><span class="line">    B --&gt;|send Trace Data| D</span><br><span class="line">    C --&gt;|send Trace Data| D</span><br><span class="line">end</span><br><span class="line">D --&gt; E(Zipkin UI -dash board\n显示数据)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="Sleuth-工作原理"><a href="#Sleuth-工作原理" class="headerlink" title="Sleuth 工作原理"></a>Sleuth 工作原理</h3><p>一条链路通过Trace Id唯一标识  ,Span标识发起的请求信息</p>
<p>Trace：类似于树结构的Span集合，表示一条调用链路，存在唯一标识<br>Span：基本工作单元，表示调用链路来源，通俗的理解span就是一次请求信息</p>
<p><img data-src="E:\Notes\picture\image-20230226101612558.png" alt="image-20230226101612558"></p>
<p>spans 的 parent/child 关系图形化</p>
<p><img data-src="E:\Notes\picture\image-20230226102005378.png" alt="image-20230226102005378"></p>
<h3 id="项目配置-1"><a href="#项目配置-1" class="headerlink" title="项目配置"></a>项目配置</h3><p>Zipkin仪表盘 : <code>http://localhost:9411/zipkin/</code></p>
<p>服务的消费方和提供方都要配置才能正常显示</p>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--包含了 sleuth+zipkin--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>yaml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zipkin:</span></span><br><span class="line">  <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line"><span class="attr">sleuth:</span></span><br><span class="line">  <span class="attr">sampler:</span></span><br><span class="line">    <span class="comment">#采样率 0 - 1 1表示全部采集</span></span><br><span class="line">    <span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里仪表盘找不到服务，不知道扫描原因！！！</p>
</blockquote>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p>官方文档  :  <code>https://github.com/alibaba/Nacos</code></p>
<blockquote>
<p>Nacos 就是注册中心[替代 Eureka]+配置中心[替代 Config]</p>
</blockquote>
<h3 id="项目配置-2"><a href="#项目配置-2" class="headerlink" title="项目配置"></a>项目配置</h3><p>本机界面  :  <code>http://localhost:8848/nacos</code></p>
<p>用户名/密码 为 nacos</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#配置nacos server地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="comment">#配置暴露所有监控</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>



<p>主启动类增加注解 : <code>@EnableDiscoveryClient</code></p>
<h3 id="Nacos-AP-和-CP"><a href="#Nacos-AP-和-CP" class="headerlink" title="Nacos AP 和 CP"></a>Nacos AP 和 CP</h3><p>选择 AP 还是 CP?</p>
<ul>
<li><p>CP: 服务可以不能用，但必须要保证数据的一致性。</p>
</li>
<li><p>AP: 数据可以短暂不一致，但最终是需要一致的，无论如何都要保证服务的可用。</p>
</li>
<li><p>取舍：只能在 CP 和 AP 选择一个平衡点, 大多数都是选择 AP 模式</p>
</li>
</ul>
<p>AP 和 CP 切换  :  <code>https://www.jianshu.com/p/c56e22c222bb</code></p>
<h3 id="Nacos配置中心"><a href="#Nacos配置中心" class="headerlink" title="Nacos配置中心"></a>Nacos配置中心</h3><p>官方文档  :  <code>https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html</code></p>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>nacos创建配置  :  <code>e-commerce-nacos-config-client-dev.yaml</code></p>
<p>:exclamation:   :exclamation:  :exclamation:   配置文件的后缀是 <code>.yaml</code> , 不是 <code>.yml</code></p>
<p>application.yaml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span>  <span class="comment">#指定环境为开发环境</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yaml配置</p>
<p>项目启动时先读取 bootstrap.yaml， 后读取 application.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#配置中心配置的DataID</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">e-commerce-nacos-config-client-dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#注册服务中心</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment">#配置中心，当前服务中心和配置中心是一体的</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment">#配置文件的扩展名</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure>



<p>演示拉取配置</p>
<p><code>@RefreshScope</code> : springcloud 原生注解，实现配置信息自动刷新, 如果在 NacosServer 修改了配置数据，Client 端就会得到最新配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span><span class="comment">// springcloud原生注解，实现配置自动更新</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value((&quot;$&#123;config.ip&#125;&quot;))</span></span><br><span class="line">    <span class="keyword">private</span> String configIp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value((&quot;$&#123;config.name&#125;&quot;))</span></span><br><span class="line">    <span class="keyword">private</span> String configName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nacos/config/ip&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigIp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configIp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nacos/config/name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动, 也就是说==如果项目不能正确的获取到 Nacos Server 的配置数据，项目是启动不了的==</p>
<h3 id="Nacos配置分类"><a href="#Nacos配置分类" class="headerlink" title="Nacos配置分类"></a>Nacos配置分类</h3><ol>
<li><p>data id方案</p>
<ul>
<li><p>根据环境切换Nacos Server的配置数据</p>
<ul>
<li><p>开发环境 —  dev 的配置数据</p>
</li>
<li><p>测试环境 —  test 的配置数据</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>group方案</p>
<ul>
<li>不同的开发小组对应各自开发环境的配置数据</li>
</ul>
</li>
<li><p>namespace方案</p>
<ul>
<li>不同的 组织 / 公司开发组 对应各自环境的配置数据</li>
</ul>
</li>
</ol>
<p><code>namespace / group / data id</code> 的关系</p>
<ul>
<li>Nacos默认的命名空间是public，Namespace主要用来实现配置隔离, 隔离范围大</li>
<li>Group默认是DEFAULT GROUP，Group可以把不同的微服务划分到同一个分组里面去</li>
<li>Service就是微服务, 相同的Service可以是一个Cluster(簇/集群), Instance 就是微服务的实例</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">	subgraph Namespace</span><br><span class="line">		subgraph Group</span><br><span class="line">            subgraph Service</span><br><span class="line">                subgraph Cluster1</span><br><span class="line">                	A(Instance1)</span><br><span class="line">                	B(Instance2)</span><br><span class="line">                end                </span><br><span class="line">                subgraph Cluster2</span><br><span class="line">                    C(Instance3)</span><br><span class="line">                	D(Instance4)</span><br><span class="line">                end</span><br><span class="line">            end</span><br><span class="line">		end</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>



<h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><p><code>https://sentinelguard.io/zh-cn/docs/quick-start.html</code></p>
<p>Sentinel 是什么？<br>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等==多个维度保护服务的稳定性==。</p>
<h3 id="Sentinel核心功能"><a href="#Sentinel核心功能" class="headerlink" title="Sentinel核心功能"></a>Sentinel核心功能</h3><ol>
<li><p>流量控制</p>
</li>
<li><p>熔断降级</p>
<ul>
<li><p>在调用系统的时候，如果调用链路中的某个资源出现了不稳定，最终会导致请求发生堆积</p>
</li>
<li><p>熔断降级就是当检测到调用链路中某个资源出现不稳定的表现，例如请求响应时间长或异常比例升高的时候，则对这个资源的调用进行限制，==让请求快速失败，避免影响到其它的资源而导致级联故障==</p>
<img data-src="E:\Notes\picture\image-20230226145028183.png" alt="image-20230226145028183" style="zoom:50%;" /></li>
</ul>
</li>
<li><p>系统负载保护</p>
<ul>
<li>根据系统能够处理的请求，和允许进来的请求，来做平衡，追求的目标是在==系统不被拖垮的情况下, 提高系统的吞吐率==</li>
</ul>
</li>
<li><p>消息削峰填谷</p>
<ul>
<li>某<strong>瞬时来了大流量的请求</strong>, 而如果此时要处理所有请求，很可能会导致系统负载过高，影响稳定性。但其实可能后面几秒之内都没有消息投递，若直接把多余的消息丢掉则没有充分利用系统处理消息的能力</li>
<li>Sentinel 的 Rate Limiter 模式能==在某一段时间间隔内以匀速方式处理这样的请求==, 充分利用系统的处理能力, 也就是削峰填谷, 保证资源的稳定性</li>
</ul>
</li>
</ol>
<h3 id="项目配置-3"><a href="#项目配置-3" class="headerlink" title="项目配置"></a>项目配置</h3><p>引入 alibaba-sentine，集成客户端</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yaml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sentinel:</span></span><br><span class="line">  <span class="attr">transport:</span></span><br><span class="line">    <span class="comment">#集成sentinel客户端</span></span><br><span class="line">    <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">    <span class="comment">#Sentinel 控制台交互的端口，微服务应用本地会起一个该端口</span></span><br><span class="line">    <span class="comment">#默认 8719，假如被占用了, 会自动从 8719 开始依次+1 扫描。直至找到未被占用的端口</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8719</span></span><br></pre></td></tr></table></figure>





<h3 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h3><h4 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h4><img data-src="E:\Notes\picture\image-20230226152102804.png" alt="image-20230226152102804" style="zoom: 50%;" />



<ul>
<li><p>资源名∶唯一名称，默认请求路径</p>
</li>
<li><p>针对来源∶Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）</p>
</li>
<li><p>阈值类型/单机阈值 :</p>
<ul>
<li><p>QPS（每秒钟的请求数量）∶当调用该 api 的 QPS 达到阈值的时候，进行限流</p>
</li>
<li><p>线程数∶当调用该 api 的线程数达到阈值的时候，进行限流，</p>
</li>
<li><p>如果 1 个请求对应的线程平均执行时间为 0.1 那么, 就相当于QPS 为 10</p>
</li>
</ul>
</li>
<li><p>是否集群∶不需要集群</p>
</li>
<li><p>流控模式∶</p>
<ul>
<li><p>直接∶ api 达到限流条件时，直接限流</p>
</li>
<li><p>关联∶ 当关联的资源达到阈值时，就限流自己</p>
</li>
<li><p>链路∶ 当从某个接口过来的资源达到限流条件时，开启限流</p>
</li>
</ul>
</li>
<li><p>流控效果∶ </p>
<ul>
<li><p>快速失败∶直接失败，抛异常</p>
</li>
<li><p>Warm Up∶根据 codeFactor（冷加载因子，默认 3）的值，从阈值/codeFactor，经过预热时长，才达到设置的 QPS 阈值</p>
</li>
<li><p>排队等待∶匀速排队，让请求以匀速的速度通过，这种方式主要用于处理间隔性突发的流量，例如消息队列</p>
<p>比如这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p>
<p>阈值类型必须设置为 QPS，否则无效</p>
<img data-src="E:\Notes\picture\image-20230226170111712.png" alt="image-20230226170111712" style="zoom: 33%;" /></li>
</ul>
</li>
</ul>
<h4 id="warm-up"><a href="#warm-up" class="headerlink" title="warm up"></a>warm up</h4><p>当流量突然增大的时候，我们常常会希望系统从空闲状态到繁忙状态的切换的时间长一些。即如果系统在此之前长期处于空闲的状态，我们希望处理请求的数量是缓步的增多，经过预期的时间以后，到达系统处理请求个数的最大值。Warm Up(冷启动，预热)模式就是为了实现这个目的的。</p>
<p>这个场景主要用于启动需要额外开销的场景，例如建立数据库连接等</p>
<ul>
<li>请求 QPS 从 threshold / 3 开始，经预热时长逐渐升至设定的 QPS 阈值</li>
<li>这里的threshold 就是最终要达到的QPS阈值</li>
</ul>
<p>应用场景: </p>
<p>秒杀在开启瞬间，大流量很容易造成冲垮系统，Warmup 可慢慢的把流量放入，最终将阀值增长到设置阀值</p>
<h4 id="资源清洗处理URL通配符"><a href="#资源清洗处理URL通配符" class="headerlink" title="资源清洗处理URL通配符"></a>资源清洗处理URL通配符</h4><p>对于/member/get/{id}这个 URL，我们可以统一归集到/member/get/*资源下，具体配置代码如下，实现 UrlCleaner 接口，并重写 clean 方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomUrlCleaner</span> <span class="keyword">implements</span> <span class="title class_">UrlCleaner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">clean</span><span class="params">(String originUrl)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(originUrl)) &#123;</span><br><span class="line">            <span class="keyword">return</span> originUrl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (originUrl.startsWith(<span class="string">&quot;/member/get&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 1. 如果请求的是接口 /member/get 开头的, 比如/member/get/1</span></span><br><span class="line">            <span class="comment">// 2. 给 sentinel 的返回的资源名就是 /member/get/*</span></span><br><span class="line">            <span class="comment">// 3. 在 sentinel 对 /member/get/* 添加流控规则即可</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/member/get/*&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originUrl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


























      <div class="tags">
          <a href="/tags/java/" rel="tag"><i class="ic i-tag"></i> java</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-02-26 22:29:02" itemprop="dateModified" datetime="2023-02-26T22:29:02+08:00">2023-02-26</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="securemist222 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="securemist222 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="securemist222 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>securemist222 <i class="ic i-at"><em>@</em></i>
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2023/02/26/springcloud/" title="springcloud学习笔记">http://example.com/2023/02/26/springcloud/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98"><span class="toc-number">1.</span> <span class="toc-text">系统架构的演变</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1-amp-SpringCloud"><span class="toc-number">2.</span> <span class="toc-text">微服务&amp;SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCloud%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.</span> <span class="toc-text">SpringCloud说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCloud%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">SpringCloud核心组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCloud%E5%88%86%E5%B8%83%E5%BC%8F%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="toc-number">2.3.</span> <span class="toc-text">SpringCloud分布式示意图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCloud%E7%BB%84%E4%BB%B6%E9%80%89%E5%9E%8B"><span class="toc-number">2.4.</span> <span class="toc-text">SpringCloud组件选型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cloud%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">cloud项目构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dependencyManagement%E8%AF%B4%E6%98%8E"><span class="toc-number">3.1.</span> <span class="toc-text">dependencyManagement说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5ResTemplate"><span class="toc-number">3.2.</span> <span class="toc-text">注入ResTemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-Run-DashBoard"><span class="toc-number">3.3.</span> <span class="toc-text">开启 Run DashBoard</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka"><span class="toc-number">4.</span> <span class="toc-text">Eureka </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">Eureka项目架构分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA"><span class="toc-number">4.2.</span> <span class="toc-text">项目构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">4.3.</span> <span class="toc-text">维护机制 :</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.</span> <span class="toc-text">Eureka自我保护模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAEureka%E9%9B%86%E7%BE%A4"><span class="toc-number">4.5.</span> <span class="toc-text">搭建Eureka集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DiscoverClient"><span class="toc-number">4.6.</span> <span class="toc-text">DiscoverClient</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon"><span class="toc-number">5.</span> <span class="toc-text">Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Balance%E5%88%86%E7%B1%BB"><span class="toc-number">5.1.</span> <span class="toc-text">Load Balance分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon-%E6%9C%BA%E5%88%B6"><span class="toc-number">5.2.</span> <span class="toc-text">Ribbon 机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">Ribbon负载均衡算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign"><span class="toc-number">6.</span> <span class="toc-text">OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA-1"><span class="toc-number">6.1.</span> <span class="toc-text">项目构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-number">6.2.</span> <span class="toc-text">日志配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%B6%85%E6%97%B6"><span class="toc-number">6.3.</span> <span class="toc-text">调用超时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GateWay"><span class="toc-number">7.</span> <span class="toc-text">GateWay</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gateway%E7%BD%91%E5%85%B3%E6%8B%93%E6%89%91%E5%9B%BE"><span class="toc-number">7.1.</span> <span class="toc-text">Gateway网关拓扑图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gateway%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">7.2.</span> <span class="toc-text">Gateway工作机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.</span> <span class="toc-text">项目配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.4.</span> <span class="toc-text">函数式接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Predicate-%E6%96%AD%E8%A8%80"><span class="toc-number">7.5.</span> <span class="toc-text">Predicate&#x2F;断言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter"><span class="toc-number">7.6.</span> <span class="toc-text">Filter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sleuth-Zipkin"><span class="toc-number">8.</span> <span class="toc-text">Sleuth&#x2F;Zipkin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sleuth%E4%B8%8EZipkin%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">8.1.</span> <span class="toc-text">Sleuth与Zipkin的关系 :</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sleuth-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.</span> <span class="toc-text">Sleuth 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-1"><span class="toc-number">8.3.</span> <span class="toc-text">项目配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos"><span class="toc-number">9.</span> <span class="toc-text">Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-2"><span class="toc-number">9.1.</span> <span class="toc-text">项目配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-AP-%E5%92%8C-CP"><span class="toc-number">9.2.</span> <span class="toc-text">Nacos AP 和 CP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">9.3.</span> <span class="toc-text">Nacos配置中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E9%85%8D%E7%BD%AE%E5%88%86%E7%B1%BB"><span class="toc-number">9.4.</span> <span class="toc-text">Nacos配置分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel"><span class="toc-number">10.</span> <span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">10.1.</span> <span class="toc-text">Sentinel核心功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-3"><span class="toc-number">10.2.</span> <span class="toc-text">项目配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">10.3.</span> <span class="toc-text">流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">10.3.1.</span> <span class="toc-text">流控规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#warm-up"><span class="toc-number">10.3.2.</span> <span class="toc-text">warm up</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E6%B4%97%E5%A4%84%E7%90%86URL%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="toc-number">10.3.3.</span> <span class="toc-text">资源清洗处理URL通配符</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="securemist222"
      data-src="/images/header.jpg">
  <p class="name" itemprop="name">securemist222</p>
  <div class="description" itemprop="description">fasf</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">2</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">2</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NlY3VyZTAwbWlzdA==" title="https:&#x2F;&#x2F;github.com&#x2F;secure00mist"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/www.baodu.com/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/#/" rel="section"><i class="ic i-user"></i>关于我</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/02/26/my-introcude/" title="关于博主--我的第一篇博客">关于博主--我的第一篇博客</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/02/26/springcloud/" title="springcloud学习笔记">springcloud学习笔记</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">securemist222 @ securemist</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/02/26/springcloud/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
